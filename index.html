<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ルート料金計算</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; }
    #map { height: 65vh; width: 100%; margin-top: 10px; }
    #output { margin-top: 10px; font-size: 1rem; }
    .leaflet-routing-container {
      font-size: 1.2rem !important;
    }
    .input-group {
      margin-bottom: 8px;
    }
    input[type="text"] {
      width: 60%;
      padding: 6px;
      font-size: 1rem;
    }
    button {
      padding: 6px 12px;
      font-size: 1rem;
      margin-left: 6px;
    }
  </style>
  <footer style="position: relative; height: 60px; background-color: #f0f0f0;">
  <a href="main.html" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%);">
    <img src="modoru.png" alt="メインページに戻る" style="border-radius: 12px; height: 40px;">
  </a>
</footer>
</head>
<body>
  <h2>ルート料金計算</h2>
  <p>出発地と目的地を入力するか、地図をクリックしてください</p>

  <div class="input-group">
    <label>出発地：</label>
    <input type="text" id="startInput" placeholder="現在地または地名" />
    <button onclick="useGPS()">GPSで取得</button>
  </div>
  <div class="input-group">
    <label>目的地：</label>
    <input type="text" id="endInput" placeholder="地名または店名" />
    <button onclick="searchRoute()">検索</button>
  </div>

  <div id="map"></div>
  <div id="output">地図をクリックして目的地を設定してください</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

  <script>
    const map = L.map('map').setView([32.0885, 130.3501], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let startLatLng = L.latLng(32.0885, 130.3501);
    let destinationMarker;
    let routeControl;

    L.marker(startLatLng).addTo(map).bindPopup("出水市役所（出発地）").openPopup();

    const translationMap = {
      'Drive': '車で移動',
      'Walk': '徒歩',
      'Distance': '距離',
      'Time': '時間',
      'Route summary': 'ルート概要',
      'Instructions': '案内',
      'Start': '出発',
      'End': '到着'
    };

    function translateText(text) {
      for (const [en, ja] of Object.entries(translationMap)) {
        text = text.replace(new RegExp(en, 'g'), ja);
      }
      return text;
    }

    function geocode(place, callback) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const latlng = L.latLng(data[0].lat, data[0].lon);
            callback(latlng);
          } else {
            alert("場所が見つかりませんでした");
          }
        });
    }

    function useGPS() {
      if (!navigator.geolocation) {
        alert("この端末はGPSに対応していません");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          startLatLng = L.latLng(lat, lon);
          document.getElementById("startInput").value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
          L.marker(startLatLng).addTo(map).bindPopup("現在地（出発地）").openPopup();
        },
        err => {
          let message = "GPS取得に失敗しました";
          switch (err.code) {
            case 1: message += "（ユーザーが拒否）"; break;
            case 2: message += "（位置情報が取得できません）"; break;
            case 3: message += "（タイムアウト）"; break;
          }
          alert(message);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function searchRoute() {
      const startPlace = document.getElementById("startInput").value;
      const endPlace = document.getElementById("endInput").value;

      if (!startPlace || !endPlace) {
        alert("出発地と目的地を入力してください");
        return;
      }

      geocode(startPlace, startLat => {
        geocode(endPlace, endLat => {
          drawRoute(startLat, endLat);
        });
      });
    }

    function drawRoute(start, end) {
      if (routeControl) {
        map.removeControl(routeControl);
        routeControl = null;
      }

      routeControl = L.Routing.control({
        waypoints: [start, end],
        routeWhileDragging: false,
        showAlternatives: false,
        fitSelectedRoutes: true,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        createMarker: () => null,
        summaryTemplate: function(r) {
          const distanceKm = (r.totalDistance / 1000).toFixed(2);
          const timeMin = Math.round(r.totalTime / 60);
          return `
            <div>
              <b>ルート概要</b><br>
              距離：${distanceKm} km<br>
              時間：約 ${timeMin} 分
            </div>
          `;
        }
      }).addTo(map);

      routeControl.on('routesfound', function(e) {
        const route = e.routes[0];
        const distanceKm = route.summary.totalDistance / 1000;
        let fare = distanceKm <= 4 ? 1200 : 1200 + Math.ceil(distanceKm - 4) * 200;
        const base = Math.round(fare / 1.1);
        const tax = fare - base;

        document.getElementById("output").innerHTML = `
          <p><strong>計算結果（道路距離ベース）</strong></p>
          <p>距離：${distanceKm.toFixed(2)} km</p>
          <p>料金：¥${fare}</p>
          <p>原価（税抜）：¥${base}</p>
          <p>消費税（10%）：¥${tax}</p>
        `;
      });

      setTimeout(() => {
        const containers = document.querySelectorAll('.leaflet-routing-container');
        containers.forEach(container => {
          container.innerHTML = translateText(container.innerHTML);
        });
      }, 500);
    }

    map.on('click', function(e) {
      if (destinationMarker) map.removeLayer(destinationMarker);
      destinationMarker = L.marker(e.latlng).addTo(map).bindPopup("目的地").openPopup();
      drawRoute(startLatLng, e.latlng);
    });

    document.getElementById("startInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") searchRoute();
    });
    document.getElementById("endInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") searchRoute();
    });
  </script>
</body>

</html>
